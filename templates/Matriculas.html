<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Matr√≠culas - PowerOn Gym</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">
</head>
<body>

<header>
    <div class="header-container">
        <div class="logo-container">
            <img src="../static/icon.png" alt="√çcone da Academia PowerOn" class="logo">
            <img src="../static/Logo.png" alt="Logo Academia PowerOn" class="logo-texto">
        </div>
        <nav>
            <a href="{{ url_for('cidades_router') }}">Cidades</a>
            <a href="{{ url_for('alunos_router') }}">Alunos</a>
            <a href="{{ url_for('professores_router') }}">Professores</a>
            <a href="{{ url_for('modalidades_router') }}">Modalidades</a>
            <a href="{{ url_for('matriculas_router') }}" class="active">Matr√≠culas</a>
            <a href="{{ url_for('relatorio_router') }}">Relat√≥rios</a>
        </nav>
    </div>
</header>

<main class="container">
    <div class="content-box">

        <h2>Gest√£o de Matr√≠culas</h2>

        <h3>Realizar Nova Matr√≠cula</h3>
        <form id="matriculas-form">
            <div class="form-group">
                <label for="matricula-codigo">C√≥digo da Matr√≠cula:</label>
                <input type="number" id="matricula-codigo" name="matricula-codigo" required>
            </div>
            <div class="form-group form-group-large">
                <label for="matricula-aluno">Aluno:</label>
                <select id="matricula-aluno" name="matricula-aluno" required>
                    <option value="" disabled selected>Selecione o Aluno...</option>
                </select>
            </div>
            <div class="form-group form-group-large">
                <label for="matricula-modalidade">Modalidade:</label>
                <select id="matricula-modalidade" name="matricula-modalidade" required>
                    <option value="" disabled selected>Selecione a Modalidade...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="matricula-aulas">Quantidade de Aulas:</label>
                <input type="number" id="matricula-aulas" name="matricula-aulas" required>
            </div>
            <div class="form-group-full">
                <button type="submit" class="btn btn-primary">Salvar Matr√≠cula</button>
            </div>
        </form>

        <hr>

        <h3>Consultar e Listar Matr√≠culas</h3>
        <div class="area-busca">
            <input type="number" id="busca" placeholder="Buscar por C√≥digo da Matr√≠cula">
            <button id="btn-buscar">Buscar</button>
        </div>
        <div id="resultado-busca-matricula" class="resultado-destaque hidden"></div>

        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>C√≥d. Matr√≠cula</th>
                    <th>Nome do Aluno</th>
                    <th>Descri√ß√£o da Modalidade</th>
                    <th>Qtd. Aulas</th>
                    <th>Valor a Pagar</th>
                    <th>A√ß√µes</th>
                </tr>
                </thead>
                <tbody id="matriculas-tbody">
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    <p>Trabalho Pr√°tico - Estruturas de Arquivos Indexados &copy; 2025</p>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        //Sele√ß√£o dos Elementos da P√°gina
        const form = document.getElementById('matriculas-form');
        const tbody = document.getElementById('matriculas-tbody');
        const btnBuscar = document.getElementById('btn-buscar');
        const buscaInput = document.getElementById('busca');
        const resultadoBuscaDiv = document.getElementById('resultado-busca-matricula');
        const alunoSelect = document.getElementById('matricula-aluno');
        const modalidadeSelect = document.getElementById('matricula-modalidade');


        //Busca a lista de alunos no back-end
        async function carregarAlunos() {
            try {
                const response = await fetch('/alunos/buscar_todos');
                const alunos = await response.json();
                alunos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(aluno => {
                    alunoSelect.innerHTML += `<option value="${aluno.codigo}">${aluno.nome}</option>`;
                });
            } catch (error) {
                console.error('Erro ao buscar alunos:', error);
            }
        }

        //Busca a lista de modalidades no back-end
        async function carregarModalidades() {
            try {
                const response = await fetch('/modalidades/leitura_exaustiva');
                const modalidades = await response.json();
                modalidades.sort((a, b) => a.descricao.localeCompare(b.descricao)).forEach(mod => {
                    modalidadeSelect.innerHTML += `<option value="${mod.codigo}">${mod.descricao}</option>`;
                });
            } catch (error) {
                console.error('Erro ao buscar modalidades:', error);
            }
        }

        //leitura exaustiva e renderiza√ß√£o da tabela.
        async function renderizarTabela() {
            try {
                const response = await fetch('/matriculas/listar_todos');
                const matriculas = await response.json();
                tbody.innerHTML = '';

                matriculas.sort((a, b) => a.codigo - b.codigo).forEach(matricula => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${matricula.codigo}</td>
                        <td>${matricula.nomeAluno || 'N/A'}</td>
                        <td>${matricula.descricao || 'N/A'}</td>
                        <td>${matricula.qtdAulas} Aula(s)</td>
                        <td>R$ ${parseFloat(matricula.valorPagar).toFixed(2)}</td>
                        <td class="action-buttons">
                            <button class="btn-delete" data-id="${matricula.codigo}" title="Excluir">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            } catch (error) {
                console.error('Erro ao buscar matr√≠culas:', error);
                tbody.innerHTML = `<tr><td colspan="6">Erro ao carregar dados.</td></tr>`;
            }
        }

        // Adicionar nova matricula
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const novaMatricula = {
                codigo: form['matricula-codigo'].value,
                codAluno: form["matricula-aluno"].value,
                codModalidade: form["matricula-modalidade"].value,
                qtdAulas: form["matricula-aulas"].value,
            };
            console.log(form)
            try {
                const response = await fetch('/matriculas/cadastrar_matricula', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(novaMatricula)
                });
                const result = await response.json();
                if (response.ok) {
                    form.reset();
                    await renderizarTabela();
                } else {
                    alert(`Erro: ${result.erro || 'N√£o foi poss√≠vel matricular.'}`);
                }
            } catch (error) {
                console.error('Erro de rede:', error);
                alert('Erro de conex√£o ao tentar matricular.');
            }
        });

        // Buscar matricula por c√≥digo
        btnBuscar.addEventListener('click', async () => {
            const codigo = buscaInput.value;
            if (!codigo) return;
            resultadoBuscaDiv.classList.remove('hidden');
            try {
                const response = await fetch(`/matriculas/buscar_matricula_por_codigo?codigo=${codigo}`);
                const matricula = await response.json();
                if (response.ok) {
                    resultadoBuscaDiv.innerHTML = `
                    <strong>‚û°Ô∏è Matr√≠cula Encontrada:</strong><br>
                    <strong>C√≥digo:</strong> #${matricula.codigo}<br>
                    <strong>Aluno:</strong> ${matricula.nomeAluno || 'N/A'}<br>
                    <strong>Modalidade:</strong> ${matricula.descricao || 'N/A'}<br>
                    <strong>Valor Total:</strong> R$ ${parseFloat(matricula.valorPagar).toFixed(2)}
                `;
                } else {
                    resultadoBuscaDiv.innerHTML = `‚ùå ${matricula.message || 'Matr√≠cula n√£o encontrada.'}`;
                }
            } catch (error) {
                console.error('Erro de rede:', error);
                resultadoBuscaDiv.innerHTML = `‚ùå Erro de conex√£o ao buscar.`;
            }
        });


        // Excluir matricula
        tbody.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.btn-delete');
            if (deleteButton) {
                const id = deleteButton.dataset.id;
                if (confirm(`Tem certeza que deseja excluir a matr√≠cula de c√≥digo #${id}?`)) {
                    const formData = new FormData();
                    formData.append('codigo', id);
                    try {
                        const response = await fetch('/matriculas/apagar_matricula_por_codigo', {
                            method: 'POST',
                            body: formData
                        });
                        if (response.ok) {
                            await renderizarTabela();
                        } else {
                            const errorData = await response.json();
                            alert(`Erro: ${errorData.message || 'N√£o foi poss√≠vel excluir.'}`);
                        }
                    } catch (error) {
                        console.error('Erro de rede:', error);
                        alert('Erro de conex√£o ao tentar excluir.');
                    }
                }
            }
        });

        carregarAlunos();
        carregarModalidades();
        renderizarTabela();
    });
</script>
</body>
</html>